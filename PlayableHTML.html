<!DOCTYPE html>
<html>
<head>
<title>Playable Ad Bachelorarbeit</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
</head>
<body>
</body>


<script>
    
    let scaleFactor = window.innerWidth / window.innerHeight;
    console.log(scaleFactor);
    const app = new PIXI.Application({antialias: true});
    document.body.appendChild(app.view);
    app.renderer.view.style.position = "absolute";
    app.renderer.view.style.display = "block";
    app.renderer.autoDensity = true;
    app.renderer.resize(window.innerWidth, window.innerHeight);
    const scene = new PIXI.Container();
    app.stage.addChild(scene); 
    scene.x = app.screen.width / 2;
    scene.y = app.screen.height / 2;
    scene.pivot.x = scene.width / 2;
    scene.pivot.y = scene.height / 2;
    
    let sheet;
    let tamagotchi;
    let UI;
    let height;
    let width;
    let background;
    let bar;
    let barBackground;
    let health = 1;
    let tamagotchiType;
    let healed = false;
    
    const UIinteractionTypes = {
      start: 0,    
      eat: 1,
      sleep: 2,
      play: 3
    };
    
    PIXI.Loader.shared.add("Images/Spritesheet/sprites.json").load(setup);
    
    function setup() {
        sheet = PIXI.Loader.shared.resources["Images/Spritesheet/sprites.json"].spritesheet;
        startup();
    }
    
    function startup(){
        
        width = app.screen.width;
        height = app.screen.height;
        
        background = new PIXI.Sprite(sheet.textures["Start.png"]);
        background.anchor.set(0.5);
        background.height = app.screen.height/1.2;
        background.width = app.screen.width*1.5;
        background.scale.set(scaleFactor*1.1);
        scene.addChild(background);
 
        randomTrueFalse() ? tamagotchiType = "Cat" : tamagotchiType = "Dog";
        
        tamagotchi = new PIXI.AnimatedSprite(sheet.animations["Idle" + tamagotchiType]);
        tamagotchi.anchor.set(0.5);
        tamagotchi.scale.set(scaleFactor*0.8);
        tamagotchi.animationSpeed = 0.12;
        tamagotchi.play();
        scene.addChild(tamagotchi); 
        
        let UIbackground = new PIXI.Sprite(PIXI.Texture.WHITE);
        UIbackground.anchor.set(0.5);
        UIbackground.width = app.screen.width;
        UIbackground.height = app.screen.height/5;
        UIbackground.y = app.screen.height/2.5;
        scene.addChild(UIbackground);
    
        createUIElements(UIinteractionTypes.start, scene);
        createHealthbar(scene);
    }
    
    function createHealthbar(scene){
        
        barBackground = new PIXI.Sprite(sheet.textures["barBackground.png"]);
        barBackground.anchor.set(0.5);
        barBackground.scale.set(scaleFactor*0.27);
        barBackground.width= barBackground.width*0.8;
        barBackground.position.set(0, -height/2.2);
        scene.addChild(barBackground);
        
        bar = new PIXI.Container();
        bar.y = 0;
        scene.addChild(bar);
        
        let heart1 = new PIXI.Sprite(sheet.textures["heartempty.png"]);
        heart1.anchor.set(0.5);
        heart1.scale.set(scaleFactor*0.3);
        heart1.position.set(-width/2.6, -height/2.2);
        scene.addChild(heart1);
        
        let heart2 = new PIXI.Sprite(sheet.textures["heartfull.png"]);
        heart2.anchor.set(0.5);
        heart2.scale.set(scaleFactor*0.3);
        heart2.position.set(width/2.6, -height/2.2);
        scene.addChild(heart2);
    }   
    
    function createUIElements(interactionType, scene){
        
        if(UI != null){
            scene.removeChild(UI);
        }
        
        UI = new PIXI.Container();
        UI.y = app.screen.height/2.5;
        scene.addChild(UI);
        
        switch(interactionType){
            case UIinteractionTypes.start:  
                createBottomUIElement("eat",0,false, UI, UIinteractionTypes.eat, onClick);
                createBottomUIElement("sleep",1,false, UI, UIinteractionTypes.sleep, onClick);
                createBottomUIElement("play",-1,false, UI, UIinteractionTypes.play, onClick);
                break;    
            case UIinteractionTypes.eat:    
                createBottomUIElement("banana",0,true, UI);
                createBottomUIElement("strawberry",1,true, UI);
                createBottomUIElement("green-apple",-1,true, UI);
                break;
            case UIinteractionTypes.sleep:  
                createBottomUIElement("sleep",0,false, UI, null, putToSleep);
                break;
            case UIinteractionTypes.play:   break;    
        }
    }
    
    function createBottomUIElement(spriteName, position, draggable, UIContainer, interactionType, functionName){
        let obj = new PIXI.Sprite(sheet.textures[spriteName + ".png"]);
        if(interactionType != null)
            obj.interaction = interactionType;
        obj.anchor.set(0.5);
        obj.scale.set(scaleFactor*0.3);
        
        obj.position.x += obj.width*1.5 * position;
        
        obj.interactive = true;
        obj
        //events for drag start
        .on('mousedown', onDragStart)
        .on('touchstart', onDragStart)
        
        if(draggable){
            obj
            .on('mousemove', onDragMove)
            .on('touchmove', onDragMove)
            .on('mouseup', onDragEnd)
            .on('mouseupoutside', onDragEnd)
            .on('touchend', onDragEnd)
            .on('touchendoutside', onDragEnd);
        }else{
            obj   // events for drag end
            .on('mouseup', functionName)
            .on('mouseupoutside', functionName)
            .on('touchend', functionName)
            .on('touchendoutside', functionName);
        }
        
        UIContainer.addChild(obj);
    }
    
    function updateHealthbar(amount){
        if(!healed){
            health += amount;
            if(health<8){
                let newHealthPart = new PIXI.Sprite(sheet.textures["bar.png"]);
                newHealthPart.anchor.set(0.5);
                newHealthPart.scale.set(scaleFactor*0.2);
                newHealthPart.width= (barBackground.width/6)*amount;
                newHealthPart.position.set(-barBackground.width/2 + (newHealthPart.width/2.5)*health, -height/2.2);
                bar.addChild(newHealthPart);
            }else{
                healed = true;
                tamagotchi.textures = sheet.animations["Jump" + tamagotchiType];
                tamagotchi.animationSpeed = 0.09;
                tamagotchi.play();
            } 
        }
    }
     
    function onDragStart(event){
    // store a reference to the data
    // the reason for this is because of multitouch
    // we want to track the movement of this particular touch
    this.data = event.data;
    this.scale.set(this.scale.x*1.2);
    this.oldPosition = Object.assign({}, this.position);
    this.dragging = true;
}
    function onDragEnd(){
        this.scale.set(this.scale.x/1.2);
        this.dragging = false;
        if(collisionWithAnimal(this)){
            this.parent.removeChild(this);
            updateHealthbar(2);
        }else{
            this.position.set(this.oldPosition._x, this.oldPosition._y);
        }
        
        // set the interaction data to null
        this.data = null;
    }
    function onDragMove(){
        if (this.dragging)
        {
            var newPosition = this.data.getLocalPosition(this.parent);
            this.position.x = newPosition.x;
            this.position.y = newPosition.y;
        }
}
    
    function onClick(){
        this.scale.set(this.scale.x/1.2);
        this.dragging = false;

        switch(this.interaction){
            case UIinteractionTypes.eat:    background.texture = sheet.textures["EatBackground.png"];
                                            createUIElements(UIinteractionTypes.eat, scene);
                                            break;
            case UIinteractionTypes.sleep:  background.texture = sheet.textures["SleepBackground.png"];
                                            createUIElements(UIinteractionTypes.sleep, scene);
                                            break;
            case UIinteractionTypes.play:   background.texture = sheet.textures["PlayBackground.png"];
                                            createUIElements(UIinteractionTypes.play, scene);
                                            break;   
        }
        
    }
    function putToSleep(){
        background.texture = sheet.textures["SleepBackground2.png"];
        setInterval(updateHealthbar,1000, 1);
    }    
    function randomTrueFalse(){
        return (Math.floor(Math.random()*10) < 5);
    }
    function collisionWithAnimal(otherObj){
      var first = tamagotchi.getBounds();
      var second = otherObj.getBounds();
      return    first.x + first.width > second.x && 
                first.x < second.x + second.width && 
                first.y + first.height > second.y && 
                first.y < second.y + second.height;
    }
    
    function endingScreen(){
        
    }
    
</script>
    
</html>